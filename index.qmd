---
title: "Работа с геоданными в R"
subtitle: <https://agricolamz.github.io/2025.05.16_HSE_R_Meet_Up>
author:
  - name: Георгий Мороз
    affiliations:
      - name: Международная лаборатория языковой конвергенции НИУ ВШЭ
lang: ru
language: 
  title-block-affiliation-single: ""
  title-block-author-single: ""
  title-block-published: ""
date: '05/16/2025'
date-format: 'D.MM.YYYY'
format: html
toc: true
editor_options: 
  chunk_output_type: console
---

Мне хочется выразить благодарность Евгению Николаевичу Матерову за его блог и телеграм-канал "Наука и данные" (<https://t.me/naukaidannye>), которые значительно упростили написание данной лекции.

```{r}
library(leaflet)
library(tidyverse)
library(sf)
library(maptiles)
library(tidyterra)
```

##  Обо мне

- полевой исследователь (31 поездка, почти все на Кавказ)
- фонетист, фонолог, квантитативный лингвист, занимаюсь линвистической географией
- преподаю статистику с применением R
- преподавал и руководил [мастерской по анализу данных](https://www.letnyayashkola.org/andan/) на Летней школе
- записал онлайн курс ["Введение в анализ данных на R для гуманитарных и социальных наук"](https://openedu.ru/course/hse/IDAR/), [материалы](https://agricolamz.github.io/daR4hs/) доступны онлайн
- написал несколько лингвистических пакетов для R
    - [`lingtypology`](https://ropensci.github.io/lingtypology/)
    - [`phonfieldwork`](https://docs.ropensci.org/phonfieldwork/)
    - [`lingglosses`](https://github.com/agricolamz/lingglosses)

## Анализ пространственных данных

Анализ данных может включать

-   сбор данных
-   очистку данных и их предобработку
-   визуализацию данных
-   моделирование данных
-   дескриптивный анализ
-   предиктивный анализ
-   машинное обучение
-   ...

Анализ пространственных данных --- анализ данных, который основывается на понятиях места, расстояний и пространственного взаимодействия как ключевых признаков данных и использует особые инструменты и методы для хранения, визуализации и исследования такого типа данных.

### Пространственные примитивы

В картографии существуют свои элементарные единицы:

```{r}
#| echo: false

knitr::include_graphics("images/01_geometries.png")
```

Эти единицы поддерживают популярные пакеты для манипуляции с георграфическими объектами: `sp`, `sf` и другие. В данном разделе мы не будем учиться операциям с этими объектами (объединение, вычитание и т. п., подробности смотрите в документации к пакету `sp`). Все эти единицы относятся к векторному типу данных.

Кроме того, существует отдельный тип географических данных --- растровый. Такой тип данных подразумевает, некоторую регулярную сетку измерений, например, квадратов, в которых произведен замер (количество выпавших осадков, высотность, граница суши и др.).

```{r}
#| echo: false

knitr::include_graphics("images/02_snow_prob.jpg")
```

Векторные и растровые данные обычно решают разные задачи. Часто во время анализа необходимо комбинировать разные типы данных: например, мы в лаборатории давно мечтаем, чтобы кто-то дигитализировал дороги из старых карт Дагестана, так как современные дороги не отражают исторических связей между населенными пунктами. Бывает и обратное: например, для того, чтобы сделать вывод о ДТП в Москве, имеет смысл перейти от конкретных географических координат к некоторой обобщенной растровой сетке. Важно еще сказать, что легче искать связи в растровых данных, так как становится доступна картографическая алгебра:

```{r}
#| echo: false

knitr::include_graphics("images/03_map_algebra.png")
```

### Картографические проекции

Любое отображение некоторого небесного тела на плоскость называют картографической проекцией. 

Если расстояния в ваших данных небольшие (особенно, если координаты близки к экватору), широту и долготу можно без страха использовать как оси в декартовой системе координат (она же --- проекция Меркатора). Однако при работе с данными масштаба страны/континента/планеты такой подход будет накапливать ошибку из-за искажений одного из следующих типов:

- искажения длин;
- искажения углов;
- искажения площадей;
- искажения форм.

Проекция Меркатора очень сильно искажает площади:

```{r}
#| echo: false
#| layout-ncol: 2
#| out-width: 100%
#| fig-cap: источник --- Википедия
#| fig-subcap:
#| - исходный
#| - с сохранением площадей

knitr::include_graphics("images/04-Merkator-1.png")
knitr::include_graphics("images/05-Merkator-2.png")
```

- [веб-приложение](https://projectionwizard.org/), помогающее выбрать подходящую проекцию
- [веб-приложение](https://mathigon.org/course/circles/spheres-cones-cylinders#sphere-maps), которое показывает как изменяются объекты при преобразовании с сферы на одну из четырех проекций (Меркатора, цилиндрическую, Робинсона, Моллвейде)
- [Здесь](https://proj.org/en/latest/operations/projections/all_images.html) содержится список всех возможных проекций

### География + время

```{r}
#| echo: false

knitr::include_graphics("images/06_paris.png")
```

## Пакеты для визуализации географических данных в R

- Интерактивные
    - [`leaflet`](https://rstudio.github.io/leaflet/index.html)
    - [`mapgl`](https://walker-data.com/mapgl/index.html)
- Статические
    - `ggplot2` + `sf`, `tidyterra`, `maptiles`
    - ...

Давайте нарисуем данные кладбища Стародуб (данные полевого архива [SFIRA](https://sfira.org/)).

::: {.panel-tabset}

### `ggplot2` 

```{r}
read_csv("https://raw.githubusercontent.com/agricolamz/2025.05.16_HSE_R_Meet_Up/refs/heads/main/data/starodub.csv",
         show_col_types = FALSE) |> 
  st_as_sf(coords = c("longitude", "latitude"),
         crs = "+proj=lonlat") |> 
  st_transform(3857) ->
  starodub

tile <- get_tiles(starodub, provider = "OpenTopoMap", zoom = 16)

ggplot() +
  geom_spatraster_rgb(data = tile, alpha = 0.3) +
  geom_sf(data = starodub)+
  theme_minimal()+
  labs(x = NULL, y = NULL, color = NULL)
```

### `leaflet` 

```{r}
starodub <- read_csv("https://raw.githubusercontent.com/agricolamz/2025.05.16_HSE_R_Meet_Up/refs/heads/main/data/starodub.csv")

starodub |> 
  leaflet() |>  
  addProviderTiles("OpenTopoMap") |> 
  addCircles(lng = ~longitude, # обратите внимание на особый синтаксис с тильдой
             lat = ~latitude,
             color = "black",
             label = ~tombstone_code,
             opacity = 1)
```

:::


```{r}
#| echo: false

knitr::include_graphics("images/07_airplane.jpg")
```


## Моделирование

Моделирование пространственных отношений позволяет отвечать на вопросы:

- Существует ли какая-то группировка значений исследуемой переменной в пространстве?
- Правда ли, что сходные значения имеют тенденцию находиться рядом?
- Можно ли выделить какие-то регионы концентрации каких-то из значений?

Однако для ответа на все эти вопросы мы прежде всего должны построить граф соседства. Как определить соседей?

```{r}
#| out-width: 100%
#| fig-align: center

knitr::include_graphics("images/08-neighbour.png")
knitr::include_graphics("images/09-neighbour.png")
knitr::include_graphics("images/10-neighbour.png")
```

Из курса М. Фляйшманна "Spatial Data Science for Social Geography"

### Пространственная автокорреляция

Степень в какой сходные значения находятся рядом.

- положительная автокорреляция: похожие значения находятся рядом
- отрицательная автокорреляция: похожие значения находятся далеко друг от друга
- глобальная: имеют ли значения тенденцию оказываться рядом с другими похожими/непохожими значениями;
- локальная: существует ли некоторый специфический фрагментм пространства, где наблюдается необычная концентрация похожими/непохожих значений.

### Машинное обучение

Якуб Новосад написал статью, где показывает, как использовать все три основные фреймворка машинного обучения в R (`caret`, `tidymodels`, `mlr3`) к геоданным <https://geocompx.org/post/2025/sml-bp1/>.

